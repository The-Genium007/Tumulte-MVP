# ğŸ² VTT Integration - Complete Documentation

Complete integration between Virtual Tabletops (Foundry VTT, Roll20, Alchemy RPG) and Tumulte to display dice rolls on Twitch overlays.

## ğŸ“Š Overview

### Webhook Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      HTTPS POST       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Foundry VTT    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Backend         â”‚
â”‚  Module         â”‚   Bearer Token Auth    â”‚  Tumulte         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                    â”‚
                                                    â”‚ WebSocket
                                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Roll20 Script  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Overlay Twitch  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                    â–²
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚  Alchemy        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  Extension      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Latency
- **< 100ms**: Time between dice roll in VTT and display on overlay
- **WebSocket**: Real-time push to streamer overlays

---

## ğŸ—„ï¸ Backend (AdonisJS 6)

### Data Models

#### 1. VttProvider
```typescript
{
  id: string (UUID)
  name: 'foundry' | 'roll20' | 'alchemy'
  displayName: string
  authType: 'api_key'
  isActive: boolean
  configSchema: object (JSON Schema)
}
```

Seeded with 3 providers: Foundry VTT, Roll20, Alchemy RPG

#### 2. VttConnection
```typescript
{
  id: string (UUID)
  userId: string (FK users)
  vttProviderId: string (FK vtt_providers)
  name: string
  apiKey: string (Generated by Tumulte, unique)
  webhookUrl: string
  status: 'pending' | 'active' | 'expired' | 'revoked'
  lastWebhookAt: DateTime | null
}
```

Represents a GM's connection to a specific VTT.

#### 3. Campaign (Modified)
```typescript
{
  // ... existing fields
  vttConnectionId: string | null (FK vtt_connections)
  vttCampaignId: string | null (External VTT ID)
  vttCampaignName: string | null
  vttData: object | null
  lastVttSyncAt: DateTime | null
}
```

Campaigns can now be imported from a VTT.

#### 4. Character
```typescript
{
  id: string (UUID)
  campaignId: string (FK campaigns)
  vttCharacterId: string (External VTT ID)
  name: string
  avatarUrl: string | null
  characterType: 'pc' | 'npc'
  stats: object | null (JSONB)
  inventory: object | null (JSONB)
  vttData: object | null (JSONB)
  lastSyncAt: DateTime | null
}
```

Unique constraint: `(campaign_id, vtt_character_id)`

#### 5. CharacterAssignment
```typescript
{
  id: string (UUID)
  characterId: string (FK characters)
  streamerId: string (FK streamers)
  campaignId: string (FK campaigns)
  assignedAt: DateTime
}
```

Assigns a VTT character to a Twitch streamer.

#### 6. DiceRoll
```typescript
{
  id: string (UUID)
  campaignId: string (FK campaigns)
  characterId: string (FK characters)
  vttRollId: string | null (For deduplication)
  rollFormula: string ('1d20+5')
  result: number
  diceResults: number[] (PostgreSQL Array)
  isCritical: boolean
  criticalType: 'success' | 'failure' | null
  isHidden: boolean (Hidden GM rolls)
  rollType: string | null ('attack', 'skill', etc.)
  vttData: object | null (JSONB)
  rolledAt: DateTime
}
```

Index on `vtt_roll_id` for fast deduplication.

### Controllers

#### VttController
**Endpoints:**
- `POST /webhooks/vtt/dice-roll` - Receive a dice roll
- `POST /webhooks/vtt/test` - Connection test

**Authentication:** Bearer Token (API Key)

**Rate Limiting:** 100 req/min for dice-roll

**Validation:** Zod schema for payloads

### Services

#### VttWebhookService
**Responsibilities:**
- Find Tumulte campaign from `vttConnectionId` + `vttCampaignId`
- Find or create character from `vttCharacterId`
- Handle deduplication via `vttRollId`
- Delegate recording to DiceRollService

**Methods:**
- `processDiceRoll(connection, payload)` â†’ DiceRoll
- `findOrCreateCharacter(campaign, payload)` â†’ Character
- `syncCharacter(connection, campaignId, data)` â†’ Character

#### DiceRollService
**Responsibilities:**
- Record dice rolls in database
- Emit WebSocket Transmit events
- Provide history and statistics

**WebSocket Channels:**
- `campaign/{campaignId}/dice-rolls` â†’ Event for GM
- `streamer/{streamerId}/dice-rolls` â†’ Events for streamers

**Notification Logic:**
- **Critical roll** â†’ All campaign streamers
- **Non-critical roll** â†’ Only streamer assigned to character
- **Hidden roll** â†’ Never sent to streamers

**Methods:**
- `recordDiceRoll(data)` â†’ DiceRoll
- `getCampaignRollHistory(campaignId, limit, includeHidden)` â†’ DiceRoll[]
- `getCharacterRollStats(characterId)` â†’ Stats

---

## ğŸ­ Foundry VTT Module

### Structure
```
foundry/
â”œâ”€â”€ module.json          # Manifest (compatible Foundry v11+)
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ tumulte.js      # Main script (~400 lines)
â”œâ”€â”€ styles/
â”‚   â””â”€â”€ tumulte.css     # Test button styles
â”œâ”€â”€ lang/
â”‚   â”œâ”€â”€ en.json         # EN translations
â”‚   â””â”€â”€ fr.json         # FR translations
â””â”€â”€ README.md           # Installation docs
```

### Features

#### 1. Configuration via Settings
- **Enable Integration** - On/Off
- **API Key** - Key provided by Tumulte
- **Webhook URL** - Backend endpoint (dev or prod)
- **Campaign ID** - Foundry world ID
- **Send All Rolls** - All rolls or only criticals
- **Debug Mode** - Console logs

#### 2. Dice Roll Detection
- Hook on `createChatMessage`
- Extract roll data (formula, result, dice)
- Critical detection (D&D 5e: natural 1/20 on d20)
- Hidden roll detection (whisper)
- Roll type identification (attack, skill, save, etc.)

#### 3. Webhook Sending
- JSON payload with all metadata
- Bearer Token authentication
- Error handling with UI notifications
- Deduplication via `rollId` (Foundry message ID)

#### 4. Connection Test
- "Test Connection" button in settings
- Call to `/webhooks/vtt/test`
- Display connection name on success

### Payload Sent
```json
{
  "campaignId": "my-foundry-world",
  "characterId": "actor-abc123",
  "characterName": "Gimli",
  "rollId": "message-xyz789",
  "rollFormula": "1d20+5",
  "result": 25,
  "diceResults": [20, 5],
  "isCritical": true,
  "criticalType": "success",
  "isHidden": false,
  "rollType": "attack",
  "metadata": {
    "foundryMessageId": "...",
    "foundryActorId": "...",
    "foundryRollId": "...",
    "flavor": "Longsword Attack",
    "timestamp": 1704067200000
  }
}
```

### Installation
1. Copy `foundry/` folder to `[FoundryVTT]/Data/modules/tumulte-integration/`
2. Enable module in Foundry
3. Configure settings with Tumulte API key
4. Test connection

---

## ğŸ¯ Roll20 (To Implement)

### Approach: API Script
Roll20 offers an **API Script** for **Pro** accounts.

**Similar structure:**
```javascript
on('chat:message', function(msg) {
    if (msg.type === 'rollresult') {
        sendToTumulte(msg);
    }
});
```

**File:** `modules-vtt/roll20/tumulte-integration.js`

---

## ğŸ§ª Alchemy RPG (To Implement)

### Approach: Browser Extension
Alchemy RPG has **no API**. Solution: Chrome/Firefox extension.

**How it works:**
1. Extension injects script into Alchemy page
2. DOM observer listens for dice rolls
3. Extract data from HTML
4. Send webhook to Tumulte

**Technologies:**
- Manifest V3 (Chrome Extension)
- Content Script for injection
- MutationObserver for rolls

**File:** `modules-vtt/alchemy/manifest.json` + scripts

---

## ğŸ”’ Security

### API Key
- Generated by Tumulte (format: `ta_xxx...`)
- Unique per VTT Connection
- Stored in plaintext on VTT side (local module)
- Sent via Bearer Token HTTPS

### Backend Validation
- API key verified in `vtt_connections` table
- Status must be `active`
- Rate limiting: 100 req/min per API key
- Payload validation via Zod

### WebSocket
- Private channels per campaign/streamer
- Only assigned streamers receive events
- Hidden rolls (`isHidden=true`) masked for streamers

---

## ğŸ“¡ WebSocket Events

### Channel: `campaign/{campaignId}/dice-rolls`
**Recipient:** GM only

**Event:** `dice-roll:new`
```json
{
  "event": "dice-roll:new",
  "data": {
    "id": "roll-uuid",
    "characterId": "char-uuid",
    "characterName": "Gimli",
    "characterAvatar": "https://...",
    "rollFormula": "1d20+5",
    "result": 25,
    "diceResults": [20, 5],
    "isCritical": true,
    "criticalType": "success",
    "isHidden": false,
    "rollType": "attack",
    "rolledAt": "2024-01-01T12:00:00Z"
  }
}
```

### Channel: `streamer/{streamerId}/dice-rolls`
**Recipients:** Campaign streamers

**Event 1:** `dice-roll:critical` (all streamers)
```json
{
  "event": "dice-roll:critical",
  "data": {
    // ... same structure
    "isOwnCharacter": true/false
  }
}
```

**Event 2:** `dice-roll:new` (assigned streamer only)
```json
{
  "event": "dice-roll:new",
  "data": {
    // ... same structure
    "isOwnCharacter": true
  }
}
```

---

## ğŸš€ Next Steps

### Phase 2: GM Frontend

**Pages to create:**
1. `/mj/vtt-connections` - List VTT connections
2. `/mj/vtt-connections/create` - Create connection
3. `/mj/campaigns/import` - Import from VTT
4. `/mj/campaigns/:id/characters` - Manage assignments

**Components:**
- `VttConnectionCard.vue` - Connection card
- `CharacterAssignmentTable.vue` - Assignment table
- `DiceRollHistory.vue` - Roll history

### Phase 3: Streamer Frontend

**Pages:**
1. `/streamer/campaigns/:id/character` - Choose character
2. `/streamer/studio/dice-rolls` - Preview dice rolls

### Phase 4: Overlay

**Components:**
- `DiceRollOverlay.vue` - Animated roll display
- Integration in existing Overlay Studio
- CSS/GSAP animations for rolls

**Display Logic:**
- Display for 5-10 seconds
- Queue if multiple simultaneous rolls
- Different styles: success (green), failure (red)
- Hide `isHidden` rolls with "???"

### Phase 5: Tests

**Backend Tests:**
- Service unit tests
- Webhook endpoint functional tests
- WebSocket integration tests

**Foundry Tests:**
- Manual testing in Foundry v11/v12
- Test with different systems (D&D 5e, Pathfinder, etc.)

---

## ğŸ“Š Database

### Created Migrations (6 total)
1. `create_vtt_providers_table` âœ…
2. `create_vtt_connections_table` âœ…
3. `create_characters_table` âœ…
4. `create_character_assignments_table` âœ…
5. `create_dice_rolls_table` âœ…
6. `add_vtt_fields_to_campaigns_table` âœ…

### Seeders
- `vtt_provider_seeder` âœ… (3 providers created)

---

## ğŸ¨ Nomenclature

### Database (snake_case)
- Tables: `vtt_connections`, `dice_rolls`, `character_assignments`
- Columns: `vtt_campaign_id`, `last_sync_at`, `is_critical`

### Code (camelCase)
- Properties: `vttConnectionId`, `lastSyncAt`, `isCritical`
- Methods: `processDiceRoll`, `findOrCreateCharacter`

### Models (PascalCase)
- Classes: `VttConnection`, `DiceRoll`, `Character`

---

## ğŸ“ Complete Checklist

### Backend âœ…
- [x] DB Migrations (6)
- [x] Models (5 + 1 modified)
- [x] VttWebhookController
- [x] VttWebhookService
- [x] DiceRollService
- [x] Webhook routes
- [x] VTT providers seeder
- [x] Typecheck tests
- [x] Lint tests
- [x] Server starts

### Foundry Module âœ…
- [x] Module structure
- [x] module.json manifest
- [x] Main script (tumulte.js)
- [x] Translations (EN/FR)
- [x] CSS styles
- [x] README documentation

### To Do ğŸ“‹
- [ ] Roll20 API Script
- [ ] Alchemy browser extension
- [ ] GM Frontend (VTT pages)
- [ ] Streamer Frontend (character selection)
- [ ] Overlay component
- [ ] Backend tests
- [ ] Manual Foundry tests
- [ ] User documentation

---

## ğŸ”— Resources

### Foundry VTT Documentation
- API Reference: https://foundryvtt.com/api/
- Module Development: https://foundryvtt.com/article/module-development/
- Hooks: https://foundryvtt.com/api/hookEvents.html

### Roll20 Documentation
- API: https://help.roll20.net/hc/en-us/articles/360037256714-API
- Scripts: https://github.com/Roll20/roll20-api-scripts

### Alchemy RPG Documentation
- No official API
- DOM reverse engineering required

---

**Developed with â¤ï¸ for Tumulte**
