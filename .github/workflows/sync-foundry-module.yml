name: Sync Foundry Module

# Ce workflow synchronise le contenu de modules-vtt/foundry
# vers le repo externe Tumulte-Foundry-module
# Il se dÃ©clenche APRÃˆS les CI staging/production (sur push, pas sur PR)

on:
  push:
    branches:
      - staging
      - main
    paths:
      - 'modules-vtt/foundry/**'
  
  # DÃ©clenchement manuel avec choix de branche
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Branche cible (staging ou main)'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - main


jobs:
  sync-to-foundry-repo:
    name: Sync to Tumulte-Foundry-module
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout Tumulte (full history for subtree)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # NÃ©cessaire pour git subtree (besoin de tout l'historique)
      
      - name: Determine target branch
        id: branch
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "name=${{ github.event.inputs.target_branch }}" >> $GITHUB_OUTPUT
          else
            echo "name=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT
          fi
          echo "ðŸ“Œ Target branch: $(cat $GITHUB_OUTPUT | grep name | cut -d= -f2)"

      - name: Check if sync is needed
        id: check_sync
        env:
          FOUNDRY_REPO_TOKEN: ${{ secrets.FOUNDRY_MODULE_PAT }}
        run: |
          BRANCH_NAME="${{ steps.branch.outputs.name }}"
          
          # Cloner le repo cible pour comparer
          git clone --depth 1 --branch ${BRANCH_NAME} \
            https://x-access-token:${FOUNDRY_REPO_TOKEN}@github.com/The-Genium007/Tumulte-Foundry-module.git \
            /tmp/foundry-module-target 2>/dev/null || {
              echo "ðŸ“¦ Target branch doesn't exist yet, sync needed"
              echo "needed=true" >> $GITHUB_OUTPUT
              exit 0
            }
          
          # Comparer les contenus (ignorer .git)
          if diff -rq --exclude='.git' modules-vtt/foundry/ /tmp/foundry-module-target/ > /dev/null 2>&1; then
            echo "âœ… Content is already in sync, skipping"
            echo "needed=false" >> $GITHUB_OUTPUT
          else
            echo "ðŸ“¦ Content differs, sync needed"
            diff -rq --exclude='.git' modules-vtt/foundry/ /tmp/foundry-module-target/ || true
            echo "needed=true" >> $GITHUB_OUTPUT
          fi

      - name: Configure Git
        if: steps.check_sync.outputs.needed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
    
      - name: Inject API URL based on environment
        if: steps.check_sync.outputs.needed == 'true'
        run: |
          BRANCH_NAME="${{ steps.branch.outputs.name }}"

          if [ "${BRANCH_NAME}" = "main" ]; then
            API_URL="https://api.tumulte.app"
            echo "ðŸ·ï¸ Production build - using ${API_URL}"
          else
            API_URL="https://api-staging.tumulte.app"
            echo "ðŸ§ª Staging build - using ${API_URL}"
          fi

          # Replace placeholder in tumulte.js
          sed -i "s|__TUMULTE_API_URL__|${API_URL}|g" modules-vtt/foundry/scripts/tumulte.js

          # Verify replacement
          if grep -q "__TUMULTE_API_URL__" modules-vtt/foundry/scripts/tumulte.js; then
            echo "âŒ ERROR: Placeholder was not replaced!"
            exit 1
          fi

          echo "âœ… API URL injected: ${API_URL}"

          # Commit the change (needed for subtree split)
          git add modules-vtt/foundry/scripts/tumulte.js
          git commit -m "ci: inject API URL for ${BRANCH_NAME} environment"

      - name: Debug token presence
        if: steps.check_sync.outputs.needed == 'true'
        env:
          FOUNDRY_REPO_TOKEN: ${{ secrets.FOUNDRY_MODULE_PAT }}
        run: |
          if [ -z "${FOUNDRY_REPO_TOKEN}" ]; then
            echo "âŒ Token is empty!"
            exit 1
          else
            echo "âœ… Token is present (length: ${#FOUNDRY_REPO_TOKEN})"
          fi

      - name: Extract and push Foundry module
        if: steps.check_sync.outputs.needed == 'true'
        env:
          FOUNDRY_REPO_TOKEN: ${{ secrets.FOUNDRY_MODULE_PAT }}
        run: |
          # DÃ©terminer la branche cible (mÃªme nom que la branche actuelle)
          BRANCH_NAME="${{ steps.branch.outputs.name }}"
          echo "ðŸ“¦ Syncing modules-vtt/foundry to branch: ${BRANCH_NAME}"

          # Extraire le subtree dans une branche temporaire
          echo "ðŸ”„ Extracting subtree..."
          git subtree split --prefix=modules-vtt/foundry -b temp-foundry-sync

          # Pousser vers le repo du module Foundry
          echo "ðŸš€ Pushing to Tumulte-Foundry-module..."
          git push --force \
            https://x-access-token:${FOUNDRY_REPO_TOKEN}@github.com/The-Genium007/Tumulte-Foundry-module.git \
            temp-foundry-sync:${BRANCH_NAME}

          # Nettoyer la branche temporaire
          git branch -D temp-foundry-sync

          echo "âœ… Successfully synced to ${BRANCH_NAME}"

      - name: Summary
        run: |
          BRANCH_NAME="${{ steps.branch.outputs.name }}"
          if [ "${{ steps.check_sync.outputs.needed }}" = "true" ]; then
            echo "## ðŸŽ® Foundry Module Sync Complete" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Source**: \`modules-vtt/foundry\` in Tumulte" >> $GITHUB_STEP_SUMMARY
            echo "- **Target**: \`${BRANCH_NAME}\` branch in [Tumulte-Foundry-module](https://github.com/The-Genium007/Tumulte-Foundry-module)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ "${BRANCH_NAME}" = "main" ]; then
              echo "ðŸ·ï¸ **Production release** - Ready for Foundry VTT users!" >> $GITHUB_STEP_SUMMARY
            else
              echo "ðŸ§ª **Staging release** - Available for testing" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "## â­ï¸ Foundry Module Sync Skipped" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Content is already in sync with \`${BRANCH_NAME}\` branch." >> $GITHUB_STEP_SUMMARY
          fi