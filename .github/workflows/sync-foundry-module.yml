name: Sync Foundry Module

# Ce workflow synchronise le contenu de modules-vtt/foundry
# vers le repo externe Tumulte-Foundry-module
# Il se dÃ©clenche APRÃˆS les CI staging/production (sur push, pas sur PR)

on:
  push:
    branches:
      - staging
      - main
    paths:
      - 'modules-vtt/foundry/**'

jobs:
  sync-to-foundry-repo:
    name: Sync to Tumulte-Foundry-module
    runs-on: ubuntu-latest
    # Ne se lance que si c'est un push (donc aprÃ¨s merge d'une PR validÃ©e)
    if: github.event_name == 'push'

    steps:
      - name: Checkout Tumulte (full history for subtree)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # NÃ©cessaire pour git subtree (besoin de tout l'historique)
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
    
      - name: Inject API URL based on environment
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"

          if [ "${BRANCH_NAME}" = "main" ]; then
            API_URL="https://api.tumulte.app"
            echo "ðŸ·ï¸ Production build - using ${API_URL}"
          else
            API_URL="https://api-staging.tumulte.app"
            echo "ðŸ§ª Staging build - using ${API_URL}"
          fi

          # Replace placeholder in tumulte.js
          sed -i "s|__TUMULTE_API_URL__|${API_URL}|g" modules-vtt/foundry/scripts/tumulte.js

          # Verify replacement
          if grep -q "__TUMULTE_API_URL__" modules-vtt/foundry/scripts/tumulte.js; then
            echo "âŒ ERROR: Placeholder was not replaced!"
            exit 1
          fi

          echo "âœ… API URL injected: ${API_URL}"

          # Commit the change (needed for subtree split)
          git add modules-vtt/foundry/scripts/tumulte.js
          git commit -m "ci: inject API URL for ${BRANCH_NAME} environment"
          
      - name: Extract and push Foundry module
        env:
          FOUNDRY_REPO_TOKEN: ${{ secrets.FOUNDRY_MODULE_PAT }}
        run: |
          # DÃ©terminer la branche cible (mÃªme nom que la branche actuelle)
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "ðŸ“¦ Syncing modules-vtt/foundry to branch: ${BRANCH_NAME}"

          # Extraire le subtree dans une branche temporaire
          echo "ðŸ”„ Extracting subtree..."
          git subtree split --prefix=modules-vtt/foundry -b temp-foundry-sync

          # Pousser vers le repo du module Foundry
          echo "ðŸš€ Pushing to Tumulte-Foundry-module..."
          git push --force \
            https://x-access-token:${FOUNDRY_REPO_TOKEN}@github.com/The-Genium007/Tumulte-Foundry-module.git \
            temp-foundry-sync:${BRANCH_NAME}

          # Nettoyer la branche temporaire
          git branch -D temp-foundry-sync

          echo "âœ… Successfully synced to ${BRANCH_NAME}"

      - name: Summary
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "## ðŸŽ® Foundry Module Sync Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Source**: \`modules-vtt/foundry\` in Tumulte" >> $GITHUB_STEP_SUMMARY
          echo "- **Target**: \`${BRANCH_NAME}\` branch in [Tumulte-Foundry-module](https://github.com/The-Genium007/Tumulte-Foundry-module)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${BRANCH_NAME}" = "main" ]; then
            echo "ðŸ·ï¸ **Production release** - Ready for Foundry VTT users!" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ§ª **Staging release** - Available for testing" >> $GITHUB_STEP_SUMMARY
          fi
