name: Sync Foundry Module

# Ce workflow synchronise le contenu de modules-vtt/foundry
# vers le repo externe Tumulte-Foundry-module
# - Sur PR : prÃ©-vÃ©rification (token + diff) sans push
# - Sur push (merge) : exÃ©cute le subtree push via SSH

on:
  pull_request:
    branches:
      - staging
      - main
  
  push:
    branches:
      - staging
      - main
  
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Branche cible (staging ou main)'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - main


jobs:
  # Job 1 : PrÃ©-vÃ©rification sur PR (ne pousse pas)
  foundry-pre-check:
    name: Foundry Module Pre-check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout Tumulte
        uses: actions/checkout@v4

      - name: Determine target branch
        id: branch
        run: |
          echo "name=${{ github.base_ref }}" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Target branch: ${{ github.base_ref }}"

      - name: Setup SSH for pre-check
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.FOUNDRY_DEPLOY_KEY }}

      - name: Check if sync will be needed
        run: |
          BRANCH_NAME="${{ steps.branch.outputs.name }}"
          
          git clone --depth 1 --branch ${BRANCH_NAME} \
            git@github.com:The-Genium007/Tumulte-Foundry-module.git \
            /tmp/foundry-module-target 2>/dev/null || {
              echo "ðŸ“¦ Target branch '${BRANCH_NAME}' doesn't exist yet"
              echo "âž¡ï¸ Will create branch on merge"
              exit 0
            }
          
          if diff -rq --exclude='.git' modules-vtt/foundry/ /tmp/foundry-module-target/ > /dev/null 2>&1; then
            echo "âœ… Content is already in sync with '${BRANCH_NAME}'"
            echo "âž¡ï¸ No sync needed on merge"
          else
            echo "ðŸ“¦ Content differs from '${BRANCH_NAME}'"
            echo "âž¡ï¸ Will sync on merge"
            echo ""
            echo "Changed files:"
            diff -rq --exclude='.git' modules-vtt/foundry/ /tmp/foundry-module-target/ || true
          fi

      - name: Summary
        run: |
          BRANCH_NAME="${{ steps.branch.outputs.name }}"
          echo "## ðŸ” Foundry Module Pre-check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… SSH key is valid" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Œ Target: \`${BRANCH_NAME}\` branch in [Tumulte-Foundry-module](https://github.com/The-Genium007/Tumulte-Foundry-module)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â„¹ï¸ Sync will execute after merge" >> $GITHUB_STEP_SUMMARY


  # Job 2 : Push effectif sur merge ou workflow_dispatch
  sync-to-foundry-repo:
    name: Sync to Tumulte-Foundry-module
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout Tumulte (full history for subtree)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.FOUNDRY_DEPLOY_KEY }}

      - name: Determine target branch
        id: branch
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "name=${{ github.event.inputs.target_branch }}" >> $GITHUB_OUTPUT
          else
            echo "name=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT
          fi
          echo "ðŸ“Œ Target branch: $(grep name $GITHUB_OUTPUT | cut -d= -f2)"

      - name: Check if sync is needed
        id: check_sync
        run: |
          BRANCH_NAME="${{ steps.branch.outputs.name }}"
          
          git clone --depth 1 --branch ${BRANCH_NAME} \
            git@github.com:The-Genium007/Tumulte-Foundry-module.git \
            /tmp/foundry-module-target 2>/dev/null || {
              echo "ðŸ“¦ Target branch doesn't exist yet, sync needed"
              echo "needed=true" >> $GITHUB_OUTPUT
              exit 0
            }
          
          if diff -rq --exclude='.git' modules-vtt/foundry/ /tmp/foundry-module-target/ > /dev/null 2>&1; then
            echo "âœ… Content is already in sync, skipping"
            echo "needed=false" >> $GITHUB_OUTPUT
          else
            echo "ðŸ“¦ Content differs, sync needed"
            diff -rq --exclude='.git' modules-vtt/foundry/ /tmp/foundry-module-target/ || true
            echo "needed=true" >> $GITHUB_OUTPUT
          fi

      - name: Configure Git
        if: steps.check_sync.outputs.needed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Inject API URL based on environment
        if: steps.check_sync.outputs.needed == 'true'
        run: |
          BRANCH_NAME="${{ steps.branch.outputs.name }}"

          if [ "${BRANCH_NAME}" = "main" ]; then
            API_URL="https://api.tumulte.app"
            echo "ðŸ·ï¸ Production build - using ${API_URL}"
          else
            API_URL="https://api-staging.tumulte.app"
            echo "ðŸ§ª Staging build - using ${API_URL}"
          fi

          sed -i "s|__TUMULTE_API_URL__|${API_URL}|g" modules-vtt/foundry/scripts/tumulte.js

          if grep -q "__TUMULTE_API_URL__" modules-vtt/foundry/scripts/tumulte.js; then
            echo "âŒ ERROR: Placeholder was not replaced!"
            exit 1
          fi

          echo "âœ… API URL injected: ${API_URL}"

          git add modules-vtt/foundry/scripts/tumulte.js
          git commit -m "ci: inject API URL for ${BRANCH_NAME} environment"

      - name: Extract and push Foundry module
        if: steps.check_sync.outputs.needed == 'true'
        run: |
          BRANCH_NAME="${{ steps.branch.outputs.name }}"
          echo "ðŸ“¦ Syncing modules-vtt/foundry to branch: ${BRANCH_NAME}"

          echo "ðŸ”„ Extracting subtree..."
          git subtree split --prefix=modules-vtt/foundry -b temp-foundry-sync

          echo "ðŸš€ Pushing to Tumulte-Foundry-module..."
          git push --force \
            git@github.com:The-Genium007/Tumulte-Foundry-module.git \
            temp-foundry-sync:${BRANCH_NAME}

          git branch -D temp-foundry-sync

          echo "âœ… Successfully synced to ${BRANCH_NAME}"

      - name: Summary
        run: |
          BRANCH_NAME="${{ steps.branch.outputs.name }}"
          if [ "${{ steps.check_sync.outputs.needed }}" = "true" ]; then
            echo "## ðŸŽ® Foundry Module Sync Complete" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Source**: \`modules-vtt/foundry\` in Tumulte" >> $GITHUB_STEP_SUMMARY
            echo "- **Target**: \`${BRANCH_NAME}\` branch in [Tumulte-Foundry-module](https://github.com/The-Genium007/Tumulte-Foundry-module)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ "${BRANCH_NAME}" = "main" ]; then
              echo "ðŸ·ï¸ **Production release** - Ready for Foundry VTT users!" >> $GITHUB_STEP_SUMMARY
            else
              echo "ðŸ§ª **Staging release** - Available for testing" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "## â­ï¸ Foundry Module Sync Skipped" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Content is already in sync with \`${BRANCH_NAME}\` branch." >> $GITHUB_STEP_SUMMARY
          fi
